version: '3.8'
services:
  app:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_NAME}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    
    # Essential for Zero-Downtime Deployments
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3000}/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    
    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-0.50}'
          memory: ${MEMORY_LIMIT:-512M}
        reservations:
          memory: ${MEMORY_RESERVATION:-128M}
      replicas: ${REPLICAS:-2}
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
    
    # Coolify/Traefik Labels for Auto-Routing
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.${SERVICE_NAME}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=websecure"
      - "traefik.http.routers.${SERVICE_NAME}.tls=true"
      - "traefik.http.routers.${SERVICE_NAME}.tls.certresolver=letsencrypt"
      - "traefik.http.services.${SERVICE_NAME}.loadbalancer.server.port=${PORT:-3000}"
      - "traefik.http.services.${SERVICE_NAME}.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.${SERVICE_NAME}.loadbalancer.healthcheck.interval=10s"

networks:
  coolify:
    external: true
