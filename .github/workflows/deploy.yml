name: NorthStack CI/CD Pipeline
on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  pull-requests: write
  id-token: write

jobs:
  # ============================================================================
  # BUILD & TEST
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================
  security-scan:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build.outputs.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # DEPLOY PREVIEW (Pull Requests only)
  # ============================================================================
  deploy-preview:
    name: Deploy Preview Environment
    needs: [build, security-scan]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment:
      name: preview-pr-${{ github.event.number }}
      url: ${{ steps.preview.outputs.url }}
    steps:
      - name: Deploy to Coolify
        id: coolify-deploy
        run: |
          RESPONSE=$(curl -s -X POST "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "image": "${{ needs.build.outputs.image_tag }}",
              "pr_number": "${{ github.event.number }}",
              "branch": "${{ github.head_ref }}"
            }')
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Get Preview URL
        id: preview
        run: |
          PREVIEW_URL="https://pr-${{ github.event.number }}-${{ github.event.repository.name }}.preview.northstack.io"
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = '${{ steps.preview.outputs.url }}';
            const imageTag = '${{ needs.build.outputs.image_tag }}';
            
            const body = `## ðŸš€ Preview Environment Deployed!
            
            | Resource | Link |
            |----------|------|
            | **Preview URL** | [${previewUrl}](${previewUrl}) |
            | **Container Image** | \`${imageTag}\` |
            
            > This preview will be automatically deleted when the PR is closed.
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Preview Environment')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  # ============================================================================
  # DEPLOY PRODUCTION (Main branch only)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update ArgoCD Application
        run: |
          curl -X POST "${{ secrets.ARGOCD_URL }}/api/v1/applications/${{ github.event.repository.name }}/sync" \
            -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "revision": "${{ github.sha }}",
              "dryRun": false,
              "prune": true
            }'

      - name: Wait for ArgoCD Sync
        run: |
          for i in {1..60}; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
              "${{ secrets.ARGOCD_URL }}/api/v1/applications/${{ github.event.repository.name }}" | \
              jq -r '.status.sync.status')
            
            if [ "$STATUS" = "Synced" ]; then
              echo "ArgoCD sync complete!"
              exit 0
            fi
            
            echo "Waiting for sync... ($i/60) Status: $STATUS"
            sleep 10
          done
          
          echo "Timeout waiting for ArgoCD sync"
          exit 1
